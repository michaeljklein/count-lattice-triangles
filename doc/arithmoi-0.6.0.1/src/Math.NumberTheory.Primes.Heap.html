<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- |</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- Module:      Math.NumberTheory.Primes.Heap</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Copyright:   (c) 2011 Daniel Fischer</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Licence:     MIT</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Maintainer:  Daniel Fischer &lt;daniel.is.fischer@googlemail.com&gt;</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Stability:   Provisional</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Portability: Non-portable (GHC extensions)</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Prime generation using a priority queue for the composites.</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- The algorithm is basically the one described in</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- &lt;http://www.cs.hmc.edu/~oneill/papers/Sieve-JFP.pdf&gt;, but</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- it uses a more efficient heap for the priority queue and a</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- larger wheel, thus it is faster (in particular, the speed</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- penalty for @'Integer'@ is much smaller) and uses less memory.</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- It is nevertheless very slow compared to a bit sieve.</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- This module is mainly intended for comparison and verification.</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, MonoLocalBinds #-}</span><span>
</span><a name="line-18"></a><span class="hs-pragma">{-# OPTIONS_GHC -funbox-strict-fields #-}</span><span>
</span><a name="line-19"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-float-in -fno-spec-constr -fno-full-laziness #-}</span><span>
</span><a name="line-20"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Math</span><span class="hs-operator">.</span><span class="hs-identifier">NumberTheory</span><span class="hs-operator">.</span><span class="hs-identifier">Primes</span><span class="hs-operator">.</span><span class="hs-identifier">Heap</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#primes"><span class="hs-identifier hs-var">primes</span></a><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#sieveFrom"><span class="hs-identifier hs-var">sieveFrom</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Unboxed</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">ST</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">ST</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 709</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span>
</span><a name="line-28"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Math.NumberTheory.Unsafe.html"><span class="hs-identifier">Math</span><span class="hs-operator">.</span><span class="hs-identifier">NumberTheory</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span></a><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-cpp">#ifndef SH_SIZE</span><span>
</span><a name="line-33"></a><span class="hs-cpp">#define SH_SIZE 31</span><span>
</span><a name="line-34"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- Composites to eliminate, components are</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- composite, multiple of prime</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- prime</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- index of step to find next multiple of prime</span><span>
</span><a name="line-40"></a><span class="hs-keyword">data</span><span> </span><a name="Del"><a href="Math.NumberTheory.Primes.Heap.html#Del"><span class="hs-identifier">Del</span></a></a><span> </span><a name="local-6989586621679039998"><a href="#local-6989586621679039998"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="D"><a href="Math.NumberTheory.Primes.Heap.html#D"><span class="hs-identifier">D</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621679039998"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621679039998"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-identifier">step</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621679040012"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040012"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-43"></a><span class="hs-comment">-- {-# INLINE step #-}</span><span>
</span><a name="line-44"></a><a name="step"><a href="Math.NumberTheory.Primes.Heap.html#step"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621679040013"><a href="#local-6989586621679040013"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#steps"><span class="hs-identifier hs-var">steps</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unsafeAt</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679040013"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">-- Priority queue as baby heap</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- Invariant: left subheap one larger than right or both</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- have the same size (and of course, heap property)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">data</span><span> </span><a name="Hipp"><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier">Hipp</span></a></a><span> </span><a name="local-6989586621679039997"><a href="#local-6989586621679039997"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="E"><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier">E</span></a></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="H"><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier">H</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621679039997"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621679039997"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">Hipp</span></a><span> </span><a href="#local-6989586621679039997"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">Hipp</span></a><span> </span><a href="#local-6989586621679039997"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- push composite-data down the heap</span><span>
</span><a name="line-55"></a><span class="hs-pragma">{-# SPECIALISE push :: Int -&gt; Int -&gt; Int -&gt; Hipp Int -&gt; Hipp Int #-}</span><span>
</span><a name="line-56"></a><span class="hs-pragma">{-# SPECIALISE push :: Word -&gt; Word -&gt; Int -&gt; Hipp Word -&gt; Hipp Word #-}</span><span>
</span><a name="line-57"></a><span class="hs-pragma">{-# SPECIALISE push :: Integer -&gt; Integer -&gt; Int -&gt; Hipp Integer -&gt; Hipp Integer #-}</span><span>
</span><a name="line-58"></a><span class="hs-identifier">push</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621679040011"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679040011"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040011"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">Hipp</span></a><span> </span><a href="#local-6989586621679040011"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">Hipp</span></a><span> </span><a href="#local-6989586621679040011"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-59"></a><a name="push"><a href="Math.NumberTheory.Primes.Heap.html#push"><span class="hs-identifier">push</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679040014"><a href="#local-6989586621679040014"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679040015"><a href="#local-6989586621679040015"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679040016"><a href="#local-6989586621679040016"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040018"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-61"></a><span>    </span><a name="local-6989586621679040017"><a href="#local-6989586621679040017"><span class="hs-identifier">less</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679040014"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>    </span><a name="local-6989586621679040018"><a href="#local-6989586621679040018"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a name="local-6989586621679040019"><a href="#local-6989586621679040019"><span class="hs-identifier">hc</span></a></a><span> </span><a name="local-6989586621679040020"><a href="#local-6989586621679040020"><span class="hs-identifier">hp</span></a></a><span> </span><a name="local-6989586621679040021"><a href="#local-6989586621679040021"><span class="hs-identifier">hw</span></a></a><span> </span><a name="local-6989586621679040022"><a href="#local-6989586621679040022"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679040023"><a href="#local-6989586621679040023"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040017"><span class="hs-identifier hs-var">less</span></a><span> </span><a href="#local-6989586621679040019"><span class="hs-identifier hs-var">hc</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040019"><span class="hs-identifier hs-var">hc</span></a><span> </span><a href="#local-6989586621679040020"><span class="hs-identifier hs-var">hp</span></a><span> </span><a href="#local-6989586621679040021"><span class="hs-identifier hs-var">hw</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040018"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679040023"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679040022"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-64"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040014"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040015"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040016"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#push"><span class="hs-identifier hs-var">push</span></a><span> </span><a href="#local-6989586621679040019"><span class="hs-identifier hs-var">hc</span></a><span> </span><a href="#local-6989586621679040020"><span class="hs-identifier hs-var">hp</span></a><span> </span><a href="#local-6989586621679040021"><span class="hs-identifier hs-var">hw</span></a><span> </span><a href="#local-6989586621679040023"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679040022"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040014"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040015"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040016"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier hs-var">E</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier hs-var">E</span></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">-- bubble down increased top to regain heap invariant</span><span>
</span><a name="line-68"></a><span class="hs-pragma">{-# SPECIALISE bubble :: Hipp Int -&gt; Hipp Int #-}</span><span>
</span><a name="line-69"></a><span class="hs-pragma">{-# SPECIALISE bubble :: Hipp Word -&gt; Hipp Word #-}</span><span>
</span><a name="line-70"></a><span class="hs-pragma">{-# SPECIALISE bubble :: Hipp Integer -&gt; Hipp Integer #-}</span><span>
</span><a name="line-71"></a><span class="hs-identifier">bubble</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621679040010"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">Hipp</span></a><span> </span><a href="#local-6989586621679040010"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">Hipp</span></a><span> </span><a href="#local-6989586621679040010"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-72"></a><a name="bubble"><a href="Math.NumberTheory.Primes.Heap.html#bubble"><span class="hs-identifier">bubble</span></a></a><span> </span><a name="local-6989586621679040024"><a href="#local-6989586621679040024"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a name="local-6989586621679040025"><a href="#local-6989586621679040025"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679040026"><a href="#local-6989586621679040026"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679040027"><a href="#local-6989586621679040027"><span class="hs-identifier">w</span></a></a><span> </span><a name="local-6989586621679040028"><a href="#local-6989586621679040028"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679040029"><a href="#local-6989586621679040029"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679040029"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-74"></a><span>        </span><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier hs-var">E</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679040028"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-75"></a><span>                </span><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier hs-var">E</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040024"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-76"></a><span>                </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a name="local-6989586621679040030"><a href="#local-6989586621679040030"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621679040031"><a href="#local-6989586621679040031"><span class="hs-identifier">lp</span></a></a><span> </span><a name="local-6989586621679040032"><a href="#local-6989586621679040032"><span class="hs-identifier">lw</span></a></a><span> </span><a name="local-6989586621679040033"><a href="#local-6989586621679040033"><span class="hs-identifier">ll</span></a></a><span> </span><a name="local-6989586621679040034"><a href="#local-6989586621679040034"><span class="hs-identifier">lr</span></a></a><span>
</span><a name="line-77"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040030"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040030"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621679040031"><span class="hs-identifier hs-var">lp</span></a><span> </span><a href="#local-6989586621679040032"><span class="hs-identifier hs-var">lw</span></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040026"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040027"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679040033"><span class="hs-identifier hs-var">ll</span></a><span> </span><a href="#local-6989586621679040034"><span class="hs-identifier hs-var">lr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679040029"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-78"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040024"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-79"></a><span>        </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a name="local-6989586621679040035"><a href="#local-6989586621679040035"><span class="hs-identifier">rc</span></a></a><span> </span><a name="local-6989586621679040036"><a href="#local-6989586621679040036"><span class="hs-identifier">rp</span></a></a><span> </span><a name="local-6989586621679040037"><a href="#local-6989586621679040037"><span class="hs-identifier">rw</span></a></a><span> </span><a name="local-6989586621679040038"><a href="#local-6989586621679040038"><span class="hs-identifier">rl</span></a></a><span> </span><a name="local-6989586621679040039"><a href="#local-6989586621679040039"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-80"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679040028"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-81"></a><span>            </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a name="local-6989586621679040040"><a href="#local-6989586621679040040"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621679040041"><a href="#local-6989586621679040041"><span class="hs-identifier">lp</span></a></a><span> </span><a name="local-6989586621679040042"><a href="#local-6989586621679040042"><span class="hs-identifier">lw</span></a></a><span> </span><a name="local-6989586621679040043"><a href="#local-6989586621679040043"><span class="hs-identifier">ll</span></a></a><span> </span><a name="local-6989586621679040044"><a href="#local-6989586621679040044"><span class="hs-identifier">lr</span></a></a><span>
</span><a name="line-82"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040040"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679040040"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679040035"><span class="hs-identifier hs-var">rc</span></a><span>
</span><a name="line-83"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040040"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621679040041"><span class="hs-identifier hs-var">lp</span></a><span> </span><a href="#local-6989586621679040042"><span class="hs-identifier hs-var">lw</span></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#mkHipp"><span class="hs-identifier hs-var">mkHipp</span></a><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040026"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040027"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679040043"><span class="hs-identifier hs-var">ll</span></a><span> </span><a href="#local-6989586621679040044"><span class="hs-identifier hs-var">lr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679040029"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-84"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040035"><span class="hs-identifier hs-var">rc</span></a><span> </span><a href="#local-6989586621679040036"><span class="hs-identifier hs-var">rp</span></a><span> </span><a href="#local-6989586621679040037"><span class="hs-identifier hs-var">rw</span></a><span> </span><a href="#local-6989586621679040028"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#mkHipp"><span class="hs-identifier hs-var">mkHipp</span></a><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040026"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040027"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679040038"><span class="hs-identifier hs-var">rl</span></a><span> </span><a href="#local-6989586621679040039"><span class="hs-identifier hs-var">rr</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040035"><span class="hs-identifier hs-var">rc</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040035"><span class="hs-identifier hs-var">rc</span></a><span> </span><a href="#local-6989586621679040036"><span class="hs-identifier hs-var">rp</span></a><span> </span><a href="#local-6989586621679040037"><span class="hs-identifier hs-var">rw</span></a><span> </span><a href="#local-6989586621679040028"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#mkHipp"><span class="hs-identifier hs-var">mkHipp</span></a><span> </span><a href="#local-6989586621679040025"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040026"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040027"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679040038"><span class="hs-identifier hs-var">rl</span></a><span> </span><a href="#local-6989586621679040039"><span class="hs-identifier hs-var">rr</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040024"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-87"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Heap invariant violated, left smaller than right!&quot;</span><span>
</span><a name="line-88"></a><span class="hs-identifier">bubble</span><span> </span><a name="local-6989586621679040045"><a href="#local-6989586621679040045"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040045"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- join two heaps and composite-data</span><span>
</span><a name="line-91"></a><span class="hs-pragma">{-# SPECIALISE
    mkHipp :: Int -&gt; Int -&gt; Int -&gt; Hipp Int -&gt; Hipp Int -&gt; Hipp Int,
              Integer -&gt; Integer -&gt; Int -&gt; Hipp Integer -&gt; Hipp Integer -&gt; Hipp Integer,
              Word -&gt; Word -&gt; Int -&gt; Hipp Word -&gt; Hipp Word -&gt; Hipp Word
  #-}</span><span>
</span><a name="line-96"></a><span class="hs-identifier">mkHipp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-97"></a><span class="hs-identifier">mkHipp</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">p</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">w</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">go</span><span>
</span><a name="line-98"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-identifier">less</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&lt;</span><span> </span><span class="hs-identifier">c</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621679040049"><a href="#local-6989586621679040049"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679040049"><a href="#local-6989586621679040049"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-101"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-identifier">E</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-103"></a><span>                </span><span class="hs-identifier">E</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">c</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-104"></a><span>                </span><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-identifier">lp</span><span> </span><span class="hs-identifier">lw</span><span> </span><a href="#local-6989586621679040048"><span class="hs-identifier hs-var">_</span></a><span> </span><a href="#local-6989586621679040051"><span class="hs-identifier hs-var">_</span></a><span>
</span><a name="line-105"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">less</span><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-identifier">lp</span><span> </span><span class="hs-identifier">lw</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">c</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-identifier">E</span><span> </span><span class="hs-identifier">E</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-106"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040053"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-identifier">c</span><span> </span><a href="#local-6989586621679040054"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040055"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-identifier">l</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">rc</span><span> </span><span class="hs-identifier">rp</span><span> </span><span class="hs-identifier">rw</span><span> </span><span class="hs-identifier">rl</span><span> </span><span class="hs-identifier hs-var">rr</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-108"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-109"></a><span>            </span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-identifier">lp</span><span> </span><span class="hs-identifier">lw</span><span> </span><span class="hs-identifier">ll</span><span> </span><span class="hs-identifier">lr</span><span>
</span><a name="line-110"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">less</span><span> </span><a name="local-6989586621679040064"><a href="#local-6989586621679040064"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-identifier">rc</span><span>
</span><a name="line-111"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679040056"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-identifier">lp</span><span> </span><span class="hs-identifier">lw</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">ll</span><span> </span><span class="hs-identifier">lr</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-112"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="#local-6989586621679040061"><span class="hs-identifier hs-var">rc</span></a><span> </span><a href="#local-6989586621679040062"><span class="hs-identifier hs-var">rp</span></a><span> </span><a href="#local-6989586621679040063"><span class="hs-identifier hs-var">rw</span></a><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">rl</span><span> </span><span class="hs-identifier">rr</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">less</span><span> </span><span class="hs-identifier">rc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">rc</span><span> </span><span class="hs-identifier">rp</span><span> </span><span class="hs-identifier">rw</span><span> </span><a href="#local-6989586621679040056"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">rl</span><span> </span><span class="hs-identifier">rr</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040056"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-identifier">c</span><span> </span><a href="#local-6989586621679040057"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679040058"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-115"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-string">&quot;Heap invariant violated, left smaller than right!&quot;</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-comment">-- increase the top of the heap and re-heap</span><span>
</span><a name="line-118"></a><span class="hs-pragma">{-# SPECIALISE inc :: Hipp Int -&gt; Hipp Int #-}</span><span>
</span><a name="line-119"></a><span class="hs-pragma">{-# SPECIALISE inc :: Hipp Word -&gt; Hipp Word #-}</span><span>
</span><a name="line-120"></a><span class="hs-pragma">{-# SPECIALISE inc :: Hipp Integer -&gt; Hipp Integer #-}</span><span>
</span><a name="line-121"></a><span class="hs-identifier">inc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-122"></a><span class="hs-identifier">inc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier hs-type">c</span><span> </span><span class="hs-identifier hs-type">p</span><span> </span><span class="hs-identifier hs-type">i</span><span> </span><span class="hs-identifier hs-type">l</span><span> </span><span class="hs-identifier">r</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC &quot;incBubble&quot; #-}</span><span> </span><span class="hs-identifier">bubble</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">H</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">c</span><span class="hs-operator">+</span><span class="hs-identifier">p</span><span class="hs-operator">*</span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier">r</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span class="hs-identifier">inc</span><span> </span><span class="hs-identifier">h</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">h</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- while top of heap equals composite, increase and re-heap</span><span>
</span><a name="line-127"></a><span class="hs-pragma">{-# SPECIALISE adjust :: Int -&gt; Hipp Int -&gt; Hipp Int #-}</span><span>
</span><a name="line-128"></a><span class="hs-pragma">{-# SPECIALISE adjust :: Word -&gt; Hipp Word -&gt; Hipp Word #-}</span><span>
</span><a name="line-129"></a><span class="hs-pragma">{-# SPECIALISE adjust :: Integer -&gt; Hipp Integer -&gt; Hipp Integer #-}</span><span>
</span><a name="line-130"></a><span class="hs-identifier">adjust</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier hs-type">a</span><span>
</span><a name="line-131"></a><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cm</span><span> </span><span class="hs-identifier hs-type">h</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-type">H</span><span> </span><span class="hs-identifier hs-type">v</span><span> </span><span class="hs-identifier hs-type">_</span><span> </span><a href="#local-6989586621679040007"><span class="hs-identifier hs-type">_</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">cm</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">v</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cm</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inc</span><span> </span><span class="hs-identifier">h</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-identifier">adjust</span><span> </span><a href="#local-6989586621679040072"><span class="hs-identifier hs-var">_</span></a><span> </span><span class="hs-identifier hs-var">h</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#adjust"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">-- build a heap from a sorted list of Del's</span><span>
</span><a name="line-136"></a><span class="hs-pragma">{-# SPECIALISE buildH :: [Del Int] -&gt; Hipp Int #-}</span><span>
</span><a name="line-137"></a><span class="hs-pragma">{-# SPECIALISE buildH :: [Del Word] -&gt; Hipp Word #-}</span><span>
</span><a name="line-138"></a><span class="hs-pragma">{-# SPECIALISE buildH :: [Del Integer] -&gt; Hipp Integer #-}</span><span>
</span><a name="line-139"></a><span class="hs-identifier">buildH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Del</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-140"></a><span class="hs-identifier">buildH</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">E</span><span>
</span><a name="line-141"></a><a name="buildH"><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier">buildH</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">D</span><span> </span><span class="hs-identifier">s</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#E"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">tl</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-142"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">ll</span><span class="hs-special">,</span><span class="hs-identifier">rl</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">goSplit</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">tl</span><span>
</span><a name="line-144"></a><span>        </span><span class="hs-identifier">goSplit</span><span> </span><span class="hs-identifier">xs</span><span> </span><a href="#local-6989586621679040082"><span class="hs-identifier hs-var">ys</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reverse</span><span> </span><span class="hs-identifier">ys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reverse</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>        </span><a name="local-6989586621679040082"><a href="#local-6989586621679040082"><span class="hs-identifier">goSplit</span></a></a><span> </span><a name="local-6989586621679040085"><a href="#local-6989586621679040085"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621679040086"><a href="#local-6989586621679040086"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">d</span><span class="hs-glyph">:</span><span class="hs-identifier">ds</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">goSplit</span><span> </span><span class="hs-identifier">ys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">d</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">xs</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ds</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-identifier">l</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">buildH</span><span> </span><a name="local-6989586621679040088"><a href="#local-6989586621679040088"><span class="hs-identifier">ll</span></a></a><span>
</span><a name="line-147"></a><span>        </span><a name="local-6989586621679040083"><a href="#local-6989586621679040083"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier hs-var">buildH</span></a><span> </span><a href="#local-6989586621679040080"><span class="hs-identifier hs-var">rl</span></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">-- Simple sieve pushing each prime immediately onto the heap,</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- feeds the feeder, runs at about fourth root of the main sieve.</span><span>
</span><a name="line-151"></a><span class="hs-pragma">{-# SPECIALISE simpleSieve :: Hipp Int -&gt; Int -&gt; Int -&gt; [Del Int] #-}</span><span>
</span><a name="line-152"></a><span class="hs-pragma">{-# SPECIALISE simpleSieve :: Hipp Word -&gt; Word -&gt; Int -&gt; [Del Word] #-}</span><span>
</span><a name="line-153"></a><span class="hs-pragma">{-# SPECIALISE simpleSieve :: Hipp Integer -&gt; Integer -&gt; Int -&gt; [Del Integer] #-}</span><span>
</span><a name="line-154"></a><span class="hs-identifier">simpleSieve</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Del</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><a name="line-155"></a><span class="hs-identifier">simpleSieve</span><span> </span><span class="hs-identifier">h</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-type">H</span><span> </span><span class="hs-identifier hs-type">nc</span><span> </span><span class="hs-identifier hs-type">_</span><span> </span><span class="hs-identifier hs-type">_</span><span> </span><a href="#local-6989586621679040005"><span class="hs-identifier hs-type">_</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">cd</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">i</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="simpleSieve"><a href="Math.NumberTheory.Primes.Heap.html#simpleSieve"><span class="hs-identifier">cd</span></a></a><span> </span><a name="simpleSieve"><a href="Math.NumberTheory.Primes.Heap.html#simpleSieve"><span class="hs-operator">&lt;</span></a></a><span> </span><a name="simpleSieve"><a href="Math.NumberTheory.Primes.Heap.html#simpleSieve"><span class="hs-identifier">nc</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">D</span><span> </span><a name="local-6989586621679040092"><a href="#local-6989586621679040092"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">simpleSieve</span><span> </span><span class="hs-special">(</span><span class="hs-pragma">{-# SCC &quot;simplePush&quot; #-}</span><span> </span><span class="hs-identifier">push</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">h</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cd</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">simpleSieve</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#simpleSieve"><span class="hs-identifier hs-var">adjust</span></a><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">h</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cd</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-159"></a><span>        </span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cd</span><span class="hs-operator">*</span><span class="hs-identifier">cd</span><span>
</span><a name="line-160"></a><span class="hs-identifier">simpleSieve</span><span> </span><a href="#local-6989586621679040093"><span class="hs-identifier hs-var">_</span></a><span> </span><span class="hs-identifier hs-var">_</span><span> </span><a href="#local-6989586621679040093"><span class="hs-identifier hs-var">_</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- would violate an invariant</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- Feeder sieve, produces composites at the rate of the progress of the main sieve,</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- hence primes at about the square root of it, thus needs about fourth root heap</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- space. The two-step feeding makes the feeder produce faster and hence the main</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- sieve (since we have only one O(n^0.5) heap and not two.</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- Using two heaps, one small for multiples of small primes which change often</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- and one for multiples of larger primes which are less frequently updated</span><span>
</span><a name="line-168"></a><span class="hs-comment">-- speeds things up.</span><span>
</span><a name="line-169"></a><span class="hs-pragma">{-# SPECIALISE feederSieve :: [Del Int] -&gt; Hipp Int -&gt; Hipp Int -&gt; Int -&gt; Int -&gt; [Del Int] #-}</span><span>
</span><a name="line-170"></a><span class="hs-pragma">{-# SPECIALISE feederSieve :: [Del Word] -&gt; Hipp Word -&gt; Hipp Word -&gt; Word -&gt; Int -&gt; [Del Word] #-}</span><span>
</span><a name="line-171"></a><span class="hs-pragma">{-# SPECIALISE feederSieve :: [Del Integer] -&gt; Hipp Integer -&gt; Hipp Integer -&gt; Integer -&gt; Int -&gt; [Del Integer] #-}</span><span>
</span><a name="line-172"></a><span class="hs-identifier">feederSieve</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Del</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier hs-type">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Del</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><a name="line-173"></a><span class="hs-identifier">feederSieve</span><span> </span><span class="hs-identifier">dls</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">D</span><span> </span><span class="hs-identifier hs-type">s</span><span> </span><span class="hs-identifier hs-type">p</span><span> </span><a href="#local-6989586621679040004"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">ds</span><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Del"><span class="hs-identifier hs-type">sh</span></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">sc</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">_</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">_</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">lh</span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">H</span></a><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="#local-6989586621679040004"><span class="hs-identifier hs-type">_</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="feederSieve"><a href="Math.NumberTheory.Primes.Heap.html#feederSieve"><span class="hs-identifier">cd</span></a></a><span> </span><a name="feederSieve"><a href="Math.NumberTheory.Primes.Heap.html#feederSieve"><span class="hs-operator">==</span></a></a><span> </span><a name="local-6989586621679040096"><a href="#local-6989586621679040096"><span class="hs-identifier">sc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">feederSieve</span><span> </span><span class="hs-identifier">dls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inc</span><span> </span><span class="hs-identifier">sh</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">lh</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd'</span><span> </span><span class="hs-identifier">j</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040105"><span class="hs-identifier hs-var">cd</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679040102"><span class="hs-identifier hs-var">lc</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#feederSieve"><span class="hs-identifier hs-var">feederSieve</span></a><span> </span><a href="#local-6989586621679040096"><span class="hs-identifier hs-var">dls</span></a><span> </span><span class="hs-identifier">sh</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inc</span><span> </span><span class="hs-identifier">lh</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#adjust"><span class="hs-identifier hs-var">cd'</span></a><span> </span><span class="hs-identifier">j</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040105"><span class="hs-identifier hs-var">cd</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679040104"><span class="hs-identifier hs-var">s</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#feederSieve"><span class="hs-identifier hs-var">feederSieve</span></a><span> </span><a href="#local-6989586621679040096"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-identifier">sh</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">push</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#adjust"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679040105"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-identifier">p</span><span class="hs-operator">*</span><span class="hs-identifier">step</span><span> </span><a href="#local-6989586621679040103"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">u</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">lh</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd'</span><span> </span><span class="hs-identifier">j</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#feederSieve"><span class="hs-identifier hs-var">D</span></a><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#feederSieve"><span class="hs-identifier hs-var">cd</span><span class="hs-operator hs-var">*</span><span class="hs-identifier hs-var">cd</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd</span><span> </span><a href="#local-6989586621679040100"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">feederSieve</span><span> </span><span class="hs-identifier">dls</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#step"><span class="hs-identifier hs-var">sh</span></a><span> </span><span class="hs-identifier">lh</span><span> </span><span class="hs-identifier">cd'</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-178"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">cd'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679040107"><a href="#local-6989586621679040107"><span class="hs-identifier">j</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nextIndex</span><span> </span><a href="#local-6989586621679040106"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-181"></a><span class="hs-identifier">feederSieve</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">_</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">_</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">_</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- invariant violated</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">-- Build the feeder sieve, arguments are</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- first prime whose multiples have to be eliminated</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- index of step for this prime.</span><span>
</span><a name="line-186"></a><span class="hs-pragma">{-# SPECIALISE feeder :: Int -&gt; Int -&gt; [Del Int] #-}</span><span>
</span><a name="line-187"></a><span class="hs-pragma">{-# SPECIALISE feeder :: Word -&gt; Int -&gt; [Del Word] #-}</span><span>
</span><a name="line-188"></a><span class="hs-pragma">{-# SPECIALISE feeder :: Integer -&gt; Int -&gt; [Del Integer] #-}</span><span>
</span><a name="line-189"></a><span class="hs-identifier">feeder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Del</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><a name="line-190"></a><span class="hs-identifier">feeder</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">feederSieve</span><span> </span><span class="hs-identifier">lrg</span><span> </span><span class="hs-identifier hs-type">sh</span><span> </span><span class="hs-identifier">lh</span><span> </span><span class="hs-identifier">p</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Del"><span class="hs-identifier hs-type">i</span></a><span>
</span><a name="line-191"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-192"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">sml</span><span class="hs-special">,</span><span class="hs-identifier">D</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">lp</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">lrg</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">splitAt</span><span> </span><span class="hs-identifier">SH_SIZE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">D</span><span> </span><span class="hs-identifier">q</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-pragma">{-# SCC &quot;simple&quot; #-}</span><span> </span><span class="hs-identifier">simpleSieve</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">q</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">E</span><span> </span><span class="hs-identifier">E</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-operator">+</span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>        </span><span class="hs-identifier">sh</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">buildH</span><span> </span><span class="hs-identifier">sml</span><span>
</span><a name="line-194"></a><span>        </span><a name="local-6989586621679040116"><a href="#local-6989586621679040116"><span class="hs-identifier">lh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier hs-var">H</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier hs-var">lp</span></a><span> </span><a href="#local-6989586621679040111"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679040111"><span class="hs-identifier hs-var">E</span></a><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-195"></a><span>        </span><a name="local-6989586621679040117"><a href="#local-6989586621679040117"><span class="hs-identifier">q</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#H"><span class="hs-identifier hs-var">p</span></a><span class="hs-operator">*</span><a href="#local-6989586621679040112"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- The main sieve. Code almost identical to feederSieve, but we don't construct the Del,</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- which gains some performance.</span><span>
</span><a name="line-199"></a><span class="hs-pragma">{-# SPECIALISE primeSieve :: [Del Int] -&gt; Hipp Int -&gt; Hipp Int -&gt; Int -&gt; Int -&gt; [Int] #-}</span><span>
</span><a name="line-200"></a><span class="hs-pragma">{-# SPECIALISE primeSieve :: [Del Word] -&gt; Hipp Word -&gt; Hipp Word -&gt; Word -&gt; Int -&gt; [Word] #-}</span><span>
</span><a name="line-201"></a><span class="hs-pragma">{-# SPECIALISE primeSieve :: [Del Integer] -&gt; Hipp Integer -&gt; Hipp Integer -&gt; Integer -&gt; Int -&gt; [Integer] #-}</span><span>
</span><a name="line-202"></a><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Del</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Hipp</span><span> </span><span class="hs-identifier hs-type">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">a</span><span class="hs-special">]</span><span>
</span><a name="line-203"></a><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-identifier">dls</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">D</span><span> </span><span class="hs-identifier hs-type">s</span><span> </span><span class="hs-identifier hs-type">p</span><span> </span><a href="#local-6989586621679040002"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">ds</span><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Del"><span class="hs-identifier hs-type">sh</span></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">H</span><span> </span><span class="hs-identifier">sc</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">_</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">_</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">lh</span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#Hipp"><span class="hs-identifier hs-type">H</span></a><span> </span><span class="hs-identifier">lc</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="#local-6989586621679040002"><span class="hs-identifier hs-type">_</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="primeSieve"><a href="Math.NumberTheory.Primes.Heap.html#primeSieve"><span class="hs-identifier">cd</span></a></a><span> </span><span class="hs-operator">==</span><span> </span><a name="local-6989586621679040119"><a href="#local-6989586621679040119"><span class="hs-identifier">sc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-identifier">dls</span><span> </span><span class="hs-special">(</span><span class="hs-pragma">{-# SCC &quot;adjSmall&quot; #-}</span><span> </span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inc</span><span> </span><span class="hs-identifier">sh</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-pragma">{-# SCC &quot;adjLarge&quot; #-}</span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-identifier">lh</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd'</span><span> </span><span class="hs-identifier">j</span><span>
</span><a name="line-205"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040128"><span class="hs-identifier hs-var">cd</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679040125"><span class="hs-identifier hs-var">lc</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#primeSieve"><span class="hs-identifier hs-var">primeSieve</span></a><span> </span><a href="#local-6989586621679040119"><span class="hs-identifier hs-var">dls</span></a><span> </span><span class="hs-identifier">sh</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">adjust</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inc</span><span> </span><span class="hs-identifier">lh</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#adjust"><span class="hs-identifier hs-var">cd'</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#adjust"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-206"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040128"><span class="hs-identifier hs-var">cd</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679040127"><span class="hs-identifier hs-var">s</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#primeSieve"><span class="hs-identifier hs-var">primeSieve</span></a><span> </span><a href="#local-6989586621679040119"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-identifier">sh</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">push</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Primes.Heap.html#adjust"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679040128"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-identifier">p</span><span class="hs-operator">*</span><span class="hs-identifier">step</span><span> </span><a href="#local-6989586621679040126"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">u</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">lh</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">cd'</span><span> </span><span class="hs-identifier">j</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#primeSieve"><span class="hs-identifier hs-var">cd</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-identifier">dls</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#push"><span class="hs-identifier hs-var">sh</span></a><span> </span><span class="hs-identifier">lh</span><span> </span><span class="hs-identifier">cd'</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#step"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-208"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">cd'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cd</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679040130"><a href="#local-6989586621679040130"><span class="hs-identifier">j</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nextIndex</span><span> </span><a href="#local-6989586621679040129"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-211"></a><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">_</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">_</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier hs-var">_</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- invariant violated</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- | A list of primes. The sieve does not handle overflow, hence for</span><span>
</span><a name="line-214"></a><span class="hs-comment">--   bounded types, garbage occurs near @'maxBound'@. If primes that</span><span>
</span><a name="line-215"></a><span class="hs-comment">--   large are requested, use</span><span>
</span><a name="line-216"></a><span class="hs-comment">--</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-218"></a><span class="hs-comment">--   'map' 'fromInteger' $ 'takeWhile' (&lt;= 'fromIntegral' 'maxBound') 'primes'</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-220"></a><span class="hs-comment">--</span><span>
</span><a name="line-221"></a><span class="hs-comment">--   instead. Checking for overflow would be slower. The sieve is specialised</span><span>
</span><a name="line-222"></a><span class="hs-comment">--   for @'Int'@, @'Word'@ and @'Integer'@, since these are the most commonly</span><span>
</span><a name="line-223"></a><span class="hs-comment">--   used. For the fixed-width @Int@ or @Word@ types, sieving at one of the</span><span>
</span><a name="line-224"></a><span class="hs-comment">--   specialised types and converting is faster.</span><span>
</span><a name="line-225"></a><span class="hs-comment">--   To ensure sharing of the list of primes, bind it to a monomorphic variable,</span><span>
</span><a name="line-226"></a><span class="hs-comment">--   to make sure that it is not shared, use @'sieveFrom'@ with different</span><span>
</span><a name="line-227"></a><span class="hs-comment">--   arguments.</span><span>
</span><a name="line-228"></a><span class="hs-pragma">{-# SPECIALISE primes :: [Int] #-}</span><span>
</span><a name="line-229"></a><span class="hs-pragma">{-# SPECIALISE primes :: [Word] #-}</span><span>
</span><a name="line-230"></a><span class="hs-pragma">{-# SPECIALISE primes :: [Integer] #-}</span><span>
</span><a name="line-231"></a><span class="hs-identifier">primes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><a name="line-232"></a><span class="hs-identifier">primes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-glyph">:</span><span class="hs-number">3</span><span class="hs-glyph">:</span><span class="hs-number">5</span><span class="hs-glyph">:</span><span class="hs-number">7</span><span class="hs-glyph">:</span><span class="hs-number">11</span><span class="hs-glyph">:</span><span class="hs-number">13</span><span class="hs-glyph">:</span><span class="hs-identifier">sieve</span><span> </span><span class="hs-number">17</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-comment">-- | @'sieveFrom' n@ generates the list of primes @&gt;= n@.</span><span>
</span><a name="line-235"></a><span class="hs-comment">--   The remarks about overflow and performance in the documentation</span><span>
</span><a name="line-236"></a><span class="hs-comment">--   of @'primes'@ apply here too.</span><span>
</span><a name="line-237"></a><span class="hs-pragma">{-# SPECIALISE sieveFrom :: Int -&gt; [Int] #-}</span><span>
</span><a name="line-238"></a><span class="hs-pragma">{-# SPECIALISE sieveFrom :: Word -&gt; [Word] #-}</span><span>
</span><a name="line-239"></a><span class="hs-pragma">{-# SPECIALISE sieveFrom :: Integer -&gt; [Integer] #-}</span><span>
</span><a name="line-240"></a><span class="hs-identifier">sieveFrom</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">a</span><span class="hs-special">]</span><span>
</span><a name="line-241"></a><span class="hs-identifier">sieveFrom</span><span> </span><span class="hs-identifier">from</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">from</span><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-number">32768</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integer</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dropWhile</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040132"><span class="hs-operator hs-var">&lt;</span></a><span> </span><span class="hs-identifier">from</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-type">.</span><span> </span><span class="hs-identifier">fromIntegral</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sieve</span><span> </span><span class="hs-identifier">sp</span><span> </span><span class="hs-identifier">si</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">wheelPrimes</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-identifier">dls</span><span> </span><span class="hs-identifier">sh</span><span> </span><span class="hs-identifier">lh</span><span> </span><span class="hs-identifier">start</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">i0</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">-- trick the compiler into not CAFing feeder 17 0</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-identifier">sp</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">odd</span><span> </span><span class="hs-identifier">from</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">17</span><span>
</span><a name="line-249"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-identifier">si</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">even</span><span> </span><span class="hs-identifier hs-var">from</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-251"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">steps</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-glyph">-</span><span class="hs-number">2</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">q</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">r</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">from</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">18</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><span class="hs-number">30030</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-identifier">i0</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">findIx</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-number">17</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-comment">-- last number coprime to all wheel primes &lt; from</span><span>
</span><a name="line-255"></a><span>        </span><span class="hs-identifier">before</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">30030</span><span class="hs-operator">*</span><span class="hs-identifier">q</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">i0</span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>        </span><span class="hs-comment">-- first candidate</span><span>
</span><a name="line-257"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">start</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">before</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">i0</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679040139"><a href="#local-6989586621679040139"><span class="hs-identifier">sml</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">lrg</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">splitAt</span><span> </span><span class="hs-identifier">SH_SIZE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">feeder</span><span> </span><span class="hs-identifier">sp</span><span> </span><span class="hs-identifier">si</span><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679040140"><a href="#local-6989586621679040140"><span class="hs-identifier">sh</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-identifier">pushD</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#feeder"><span class="hs-identifier hs-var">E</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">findMulIx</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">D</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">sml</span><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679040142"><a href="#local-6989586621679040142"><span class="hs-identifier">lh</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dls</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC &quot;munch&quot; #-}</span><span> </span><a href="#local-6989586621679040146"><span class="hs-identifier hs-var">munch</span></a><span> </span><span class="hs-identifier">E</span><span> </span><span class="hs-identifier">lrg</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier">pushD</span><span> </span><a name="local-6989586621679040144"><a href="#local-6989586621679040144"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">c</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">push</span><span> </span><span class="hs-identifier">c</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">h</span><span>
</span><a name="line-262"></a><span>        </span><span class="hs-identifier">findMulIx</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-operator">*</span><span class="hs-identifier">mp</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#push"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-identifier">ip</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-264"></a><span>            </span><span class="hs-identifier">fpq</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">before</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">quot</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">p</span><span>
</span><a name="line-265"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679040154"><a href="#local-6989586621679040154"><span class="hs-identifier">qq</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qr</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040138"><span class="hs-identifier hs-var">fpq</span></a><span class="hs-glyph">-</span><span class="hs-number">17</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">quotRem</span><span class="hs-special">`</span><span> </span><span class="hs-number">30030</span><span>
</span><a name="line-266"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621679040155"><a href="#local-6989586621679040155"><span class="hs-identifier">ip</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">findIx</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">qr</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-number">17</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621679040157"><a href="#local-6989586621679040157"><span class="hs-identifier">mp</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">30030</span><a href="Math.NumberTheory.Primes.Heap.html#findIx"><span class="hs-operator hs-var">*</span></a><span class="hs-identifier">qq</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ip</span><span class="hs-special">)</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">step</span><span> </span><span class="hs-identifier">ip</span><span>
</span><a name="line-268"></a><span>        </span><span class="hs-identifier">munch</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">h</span><span> </span><span class="hs-identifier">dels</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">D</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ds</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">before</span><span> </span><span class="hs-operator">&lt;</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#D"><span class="hs-identifier hs-var">s</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">h</span><span class="hs-special">,</span><span class="hs-identifier">dels</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">munch</span><span> </span><span class="hs-identifier">h'</span><span> </span><span class="hs-identifier">ds</span><span>
</span><a name="line-271"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-272"></a><span>                </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-identifier">c</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">findMulIx</span><span> </span><span class="hs-identifier">p</span><span>
</span><a name="line-273"></a><span>                </span><span class="hs-identifier">h'</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">push</span><span> </span><a href="#local-6989586621679040146"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679040146"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679040146"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679040146"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-274"></a><span>        </span><span class="hs-identifier">munch</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">h</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-comment">-- Build main sieve.</span><span>
</span><a name="line-277"></a><span class="hs-pragma">{-# SPECIALISE sieve :: Int -&gt; Int -&gt; [Int] #-}</span><span>
</span><a name="line-278"></a><span class="hs-pragma">{-# SPECIALISE sieve :: Word -&gt; Int -&gt; [Word] #-}</span><span>
</span><a name="line-279"></a><span class="hs-pragma">{-# SPECIALISE sieve :: Integer -&gt; Int -&gt; [Integer] #-}</span><span>
</span><a name="line-280"></a><span class="hs-identifier">sieve</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Integral</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">a</span><span class="hs-special">]</span><span>
</span><a name="line-281"></a><span class="hs-identifier">sieve</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">primeSieve</span><span> </span><span class="hs-identifier">lrg</span><span> </span><span class="hs-identifier">sh</span><span> </span><span class="hs-identifier">lh</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-282"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-283"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">sml</span><span class="hs-special">,</span><span class="hs-identifier">D</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">lp</span><span> </span><span class="hs-identifier">j</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">lrg</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">splitAt</span><span> </span><span class="hs-identifier">SH_SIZE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">feeder</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679040171"><a href="#local-6989586621679040171"><span class="hs-identifier">sh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">buildH</span><span> </span><span class="hs-identifier">sml</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-identifier">lh</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">H</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#buildH"><span class="hs-identifier hs-var">lp</span></a><span> </span><span class="hs-identifier">j</span><span> </span><a href="#local-6989586621679040171"><span class="hs-identifier hs-var">E</span></a><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- next step index, we have 5760 numbers coprime to all wheel</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- primes in [1 .. product wheelPrimes]</span><span>
</span><a name="line-289"></a><span class="hs-pragma">{-# INLINE nextIndex #-}</span><span>
</span><a name="line-290"></a><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-291"></a><span class="hs-identifier">nextIndex</span><span> </span><span class="hs-number">5759</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-292"></a><a name="nextIndex"><a href="Math.NumberTheory.Primes.Heap.html#nextIndex"><span class="hs-identifier">nextIndex</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">1</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- The six smallest primes, that makes the supporting arrays small enough</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- and avoids enough composites to get acceptable speed (for sufficiently</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- generous values of acceptable).</span><span>
</span><a name="line-297"></a><span class="hs-identifier">wheelPrimes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Int</span><span class="hs-special">]</span><span>
</span><a name="line-298"></a><span class="hs-identifier">wheelPrimes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-glyph">:</span><span class="hs-number">3</span><span class="hs-glyph">:</span><span class="hs-number">5</span><span class="hs-glyph">:</span><span class="hs-number">7</span><span class="hs-glyph">:</span><span class="hs-number">11</span><span class="hs-glyph">:</span><span class="hs-number">13</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-comment">-- index of largest coprime &lt;= r</span><span>
</span><a name="line-301"></a><span class="hs-identifier">findIx</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-302"></a><span class="hs-identifier">findIx</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-303"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-number">30030</span><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">5759</span><span>
</span><a name="line-304"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">m</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-305"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040179"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">m</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">down</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040182"><span class="hs-identifier hs-var">up</span></a><span> </span><a href="#local-6989586621679040182"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-307"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-308"></a><span>        </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">max</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">min</span><span> </span><span class="hs-number">5758</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">192</span><span class="hs-operator">*</span><span class="hs-identifier">r</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">quot</span><span class="hs-special">`</span><span> </span><span class="hs-number">1001</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>        </span><a name="local-6989586621679040180"><a href="#local-6989586621679040180"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679040179"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-310"></a><span>        </span><span class="hs-identifier">down</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#remainders"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-311"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-number">0</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-312"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040184"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">down</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040182"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-314"></a><span>        </span><span class="hs-identifier">up</span><span> </span><span class="hs-identifier">k</span><span>
</span><a name="line-315"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">k</span><span class="hs-operator">+</span><span class="hs-number">1</span><span> </span><span class="hs-operator">&gt;</span><span> </span><span class="hs-number">5759</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">5759</span><span>
</span><a name="line-316"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679040185"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-operator">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">k</span><span>
</span><a name="line-317"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">up</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-operator">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- array of numbers coprime to all wheel primes in wheel range</span><span>
</span><a name="line-320"></a><span class="hs-identifier">remainders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">UArray</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-321"></a><span class="hs-identifier">remainders</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runSTUArray</span><span> </span><span class="hs-operator hs-type">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-322"></a><span>    </span><a name="remainders"><a href="Math.NumberTheory.Primes.Heap.html#remainders"><span class="hs-identifier">sar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">30029</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">True</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ST</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">STUArray</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-identifier">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">n2</span><span> </span><span class="hs-number">30030</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>        </span><a name="local-6989586621679040188"><a href="#local-6989586621679040188"><span class="hs-identifier">n2</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">n2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>        </span><span class="hs-identifier">n3</span><span> </span><span class="hs-number">30033</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>        </span><a name="local-6989586621679040189"><a href="#local-6989586621679040189"><span class="hs-identifier">n3</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">n3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">6</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>        </span><span class="hs-identifier">n5</span><span> </span><span class="hs-number">30035</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>        </span><a name="local-6989586621679040190"><a href="#local-6989586621679040190"><span class="hs-identifier">n5</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-329"></a><span>                </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">i</span><span class="hs-operator hs-var">+</span><span class="hs-number">20</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">n5</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">30</span><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>        </span><span class="hs-identifier">n7</span><span> </span><span class="hs-number">30037</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>        </span><a name="local-6989586621679040191"><a href="#local-6989586621679040191"><span class="hs-identifier">n7</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">n7</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">14</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>        </span><span class="hs-identifier">n11</span><span> </span><span class="hs-number">30041</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>        </span><a name="local-6989586621679040192"><a href="#local-6989586621679040192"><span class="hs-identifier">n11</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">n11</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">22</span><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-identifier">n13</span><span> </span><span class="hs-number">30043</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>        </span><a name="local-6989586621679040193"><a href="#local-6989586621679040193"><span class="hs-identifier">n13</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">n13</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">26</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier">n2</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-337"></a><span>    </span><a href="#local-6989586621679040188"><span class="hs-identifier hs-var">n3</span></a><span> </span><span class="hs-number">3</span><span>
</span><a name="line-338"></a><span>    </span><a href="#local-6989586621679040189"><span class="hs-identifier hs-var">n5</span></a><span> </span><span class="hs-number">5</span><span>
</span><a name="line-339"></a><span>    </span><a href="#local-6989586621679040190"><span class="hs-identifier hs-var">n7</span></a><span> </span><span class="hs-number">7</span><span>
</span><a name="line-340"></a><span>    </span><span class="hs-identifier">n11</span><span> </span><span class="hs-number">11</span><span>
</span><a name="line-341"></a><span>    </span><a href="#local-6989586621679040192"><span class="hs-identifier hs-var">n13</span></a><span> </span><span class="hs-number">13</span><span>
</span><a name="line-342"></a><span>    </span><a href="#local-6989586621679040193"><span class="hs-identifier hs-var">rar</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newArray_</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">5759</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ST</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">STUArray</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-identifier">Int</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">loop</span><span> </span><span class="hs-number">30031</span><span> </span><span class="hs-identifier hs-var">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">rar</span><span> </span><span class="hs-number">5759</span><span> </span><span class="hs-number">30031</span><span> </span><span class="hs-operator hs-type">&gt;&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">rar</span><span>
</span><a name="line-344"></a><span>        </span><a name="local-6989586621679040202"><a href="#local-6989586621679040202"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>            </span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">unsafeRead</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-346"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">c</span><span>
</span><a name="line-347"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-348"></a><span>                    </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">rar</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-identifier">i</span><span>
</span><a name="line-349"></a><span>                    </span><span class="hs-identifier hs-var">loop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">i</span><span class="hs-operator hs-var">+</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040201"><span class="hs-identifier hs-var">r</span><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">loop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">i</span><span class="hs-operator">+</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679040204"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-351"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-number">17</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-comment">-- distance from one coprime remainder to the next</span><span>
</span><a name="line-354"></a><span class="hs-identifier">steps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">UArray</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-355"></a><span class="hs-identifier">steps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runSTUArray</span><span> </span><span class="hs-operator hs-type">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-identifier">sar</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newArray_</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">5759</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ST</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">STUArray</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-identifier">Int</span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">loop</span><span> </span><span class="hs-number">5759</span><span> </span><span class="hs-identifier hs-var">p</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-358"></a><span>            </span><span class="hs-identifier">unsafeWrite</span><span> </span><span class="hs-identifier">sar</span><span> </span><span class="hs-number">5759</span><span> </span><span class="hs-special">(</span><span class="hs-number">30047</span><span class="hs-glyph">-</span><span class="hs-identifier">p</span><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">sar</span><span>
</span><a name="line-360"></a><span>        </span><span class="hs-identifier">loop</span><span> </span><span class="hs-identifier hs-var">i</span><span> </span><span class="hs-identifier hs-var">p</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-361"></a><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">j</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">i</span><span class="hs-operator">+</span><span class="hs-number">1</span><span>
</span><a name="line-362"></a><span>                </span><span class="hs-glyph">!</span><a name="local-6989586621679040212"><a href="#local-6989586621679040212"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">remainders</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">unsafeAt</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">j</span><span>
</span><a name="line-363"></a><span>            </span><span class="hs-identifier">unsafeWrite</span><span> </span><a href="Math.NumberTheory.Primes.Heap.html#remainders"><span class="hs-identifier hs-var">sar</span></a><span> </span><a href="Math.NumberTheory.Primes.Heap.html#remainders"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">n</span><span class="hs-glyph">-</span><span class="hs-identifier hs-var">p</span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>            </span><span class="hs-identifier hs-var">loop</span><span> </span><span class="hs-identifier hs-var">j</span><span> </span><span class="hs-identifier hs-var">n</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">17</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a></pre></body></html>